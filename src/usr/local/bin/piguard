#!/usr/bin/env bash
set -euo pipefail

PI_GUARD_OPT_DIR="/opt/piguard"
export PI_GUARD_OPT_DIR

PI_GUARD_ETC_DIR="/etc/piguard"
export PI_GUARD_ETC_DIR

PI_GUARD_GIT_DIR="/etc/.piguard"
export PI_GUARD_GIT_DIR

PI_GUARD_LOG_DIR="/var/log/piguard"
export PI_GUARD_LOG_DIR

PI_GUARD_LIST_DIR="${PI_GUARD_ETC_DIR}/lists"
export PI_GUARD_LIST_DIR

PI_GUARD_CONFIG_DIR="${PI_GUARD_ETC_DIR}/config"
export PI_GUARD_CONFIG_DIR

PI_GUARD_SOURCE_FILE="${PI_GUARD_ETC_DIR}/source.list"
export PI_GUARD_SOURCE_FILE

PI_GUARD_LOG_FILE="${PI_GUARD_LOG_DIR}/piguard.log"
export PI_GUARD_LOG_FILE

PI_GUARD_SUDO="$(sh -c "if [ 0 != \"${EUID}\" ]; then echo 'sudo'; fi")"
export PI_GUARD_SUDO

versionFunc() {
  shift
  "${PI_GUARD_OPT_DIR}"/version.sh "$@"
  exit 0
}

selfupdateFunc() {
  shift
  "${PI_GUARD_OPT_DIR}"/selfupdate.sh "$@"
  exit 0
}

reloadFunc() {
  shift
  "${PI_GUARD_OPT_DIR}"/reload.sh "$@"
  exit 0
}

fetchFunc() {
  shift
  "${PI_GUARD_OPT_DIR}"/list/fetch.sh "$@"
  exit 0
}

dnsmasqFunc() {
  shift
  "${PI_GUARD_OPT_DIR}"/network/dnsmasq.sh "$@"
  exit 0
}

iptablesFunc() {
  shift
  "${PI_GUARD_OPT_DIR}"/network/iptables.sh "$@"
  exit 0
}

networkUptimeFunc() {
  shift
  "${PI_GUARD_OPT_DIR}"/uptime/network.sh "$@"
  exit 0
}

dnsUptimeFunc() {
  shift
  "${PI_GUARD_OPT_DIR}"/uptime/dns.sh "$@"
  exit 0
}

statsFunc() {
  shift
  "${PI_GUARD_OPT_DIR}"/uptime/stats.sh "$@"
  exit 0
}

helpFunc() {
  echo "Usage: piguard [options]
Example: 'piguard -h'
Add '-h' after specific commands for more information on usage

Options:
  -v, version         Show installed version of Pi-guard
  self-update         Update Pi-guard to latest version
  reload              Reload Pi-guard configuration
  fetch               Fetch lists
  dnsmasq             Manage dnsmasq
  iptables            Manage iptables
  stats               Stats
  network-uptime      Check network uptime
  dns-uptime          Check DNS uptime";
  exit 0
}

if [[ $# = 0 ]]; then
  helpFunc
fi

case "${1:-}" in
  "self-update"                 ) selfupdateFunc "$@";;
  "selfupdate"                  ) selfupdateFunc "$@";;
  "reload"                      ) reloadFunc "$@";;
  "fetch"                       ) fetchFunc "$@";;
  "dnsmasq"                     ) dnsmasqFunc "$@";;
  "iptables"                    ) iptablesFunc "$@";;
  "stats"                       ) statsFunc "$@";;
  "network-uptime"              ) networkUptimeFunc "$@";;
  "dns-uptime"                  ) dnsUptimeFunc "$@";;
  "-v" | "version"              ) versionFunc "$@";;
  *                             ) helpFunc;;
esac
